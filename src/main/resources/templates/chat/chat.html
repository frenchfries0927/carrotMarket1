<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
  <title>Chat Room</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #F8F9FA;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .chat-container {
      max-width: 768px;
      margin: 2rem auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .chat-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e9ecef;
      background-color: #FF7E36;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    #chat {
      height: 500px;
      padding: 1.5rem;
      overflow-y: auto;
      background-color: #f8f9fa;
    }

    .chat-input-container {
      padding: 1rem;
      background: white;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      font-size: 0.875rem;
      transition: border-color 0.15s ease-in-out;
    }

    .chat-input:focus {
      outline: none;
      border-color: #FF7E36;
    }

    .send-button {
      background-color: #FF7E36;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.15s ease-in-out;
    }

    .send-button:hover {
      background-color: #FF6B1A;
    }

    /* 메시지 스타일 */
    .message {
      margin-bottom: 1rem;
      max-width: 70%;
      clear: both;
    }

    .message.sent {
      margin-left: auto;
      text-align: right;
    }

    .message.received {
      margin-right: auto;
      text-align: left;
    }

    .message-content {
      display: inline-block;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.875rem;
    }

    .message.sent .message-content {
      background-color: #FF7E36;
      color: white;
    }

    .message.received .message-content {
      background-color: #e9ecef;
      color: #343a40;
    }
  </style>
</head>
<body>
<!-- Body Fragment -->
<th:block layout:fragment="content">
  <div class="chat-container">
    <!-- 로그인한 사용자 정보를 위한 섹션 추가 -->
    <div class="my-info" style="display: none;">
      <span class="username" th:text="${loggedInUser.username}"></span>
    </div>
    <div class="chat-header">
      <img th:src="${loggedInUser.id == chatRoom.seller.id ? chatRoom.buyer.profileImage : chatRoom.seller.profileImage}" alt="상대방 프로필 사진" />
      <h1 th:text="${loggedInUser.id == chatRoom.buyer.id ? chatRoom.seller.username + '님과 채팅방' : chatRoom.buyer.username + '님과 채팅방'}">채팅방</h1>
    </div>
    <div id="chat"></div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="message" placeholder="메시지를 입력하세요..." />
      <button class="send-button" onclick="sendMessage()">Send</button>
    </div>
  </div>
</th:block>
<!-- 페이지별 JavaScript -->
<th:block layout:fragment="pageScript">
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
    import { getDatabase, ref, push, set, onChildAdded } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // Firebase 초기화 코드 (Firebase 콘솔에서 복사한 구성 정보 사용)
    const firebaseConfig = {
      apiKey: "AIzaSyDyyP59m-lGwQBRIcQ6lDpN8qtos3bcgZ0",
      authDomain: "carrotmarket1-90424.firebaseapp.com",
      databaseURL: "https://carrotmarket1-90424-default-rtdb.firebaseio.com",
      projectId: "carrotmarket1-90424",
      storageBucket: "carrotmarket1-90424.firebasestorage.app",
      messagingSenderId: "372573825138",
      appId: "1:372573825138:web:2a0f88e3dfeead7343baeb",
      measurementId: "G-T5PMZ4YJWK"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);

    // URL에서 채팅룸 ID 가져오기
    const chatRoomId = window.location.pathname.split("/").pop();

    // Firebase Database의 특정 채팅룸 경로 설정
    const chatRef = ref(database, 'chatrooms/' + chatRoomId + '/messages');

    // 메시지 수신 (새로운 메시지가 추가될 때마다)
    onChildAdded(chatRef, (snapshot) => {
      const messageData = snapshot.val();
      const usernameElement = document.querySelector('.my-info .username');
      if (usernameElement) {
        const currentUsername = usernameElement.textContent;
        const isCurrentUser = messageData.sender === currentUsername;
        displayMessage(messageData.sender, messageData.content, isCurrentUser);
      }
    });

    // 메시지 입력 필드에 엔터 키 이벤트 리스너 추가
    const messageInput = document.getElementById('message');

    // Enter 키가 눌렸을 때 sendMessage 함수 호출
    messageInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault(); // 기본 Enter 키 동작 방지 (ex: 줄바꿈)
        sendMessage();
      }
    });

    // 메시지 전송 함수 (window 객체에 추가)
    window.sendMessage = function () {
      const usernameElement = document.querySelector('.my-info .username');

      if (usernameElement) {
        const username = usernameElement.textContent;
        const message = document.getElementById('message').value;

        if (message === '') {
          alert('메시지를 입력해주세요.');
          return;
        }
// Firebase에 메시지 저장
        const newMessageRef = push(chatRef);
        set(newMessageRef, {
          sender: username,
          content: message
        });

        document.getElementById('message').value = ''; // 메시지 입력창 초기화
      } else {
        console.error('로그인한 사용자 정보를 찾을 수 없습니다.');
      }
    }

    // 화면에 메시지 표시 함수
    function displayMessage(sender, content, isCurrentUser) {
      const chat = document.getElementById('chat');
      const messageElement = document.createElement('div');
      messageElement.classList.add('message', isCurrentUser ? 'sent' : 'received');

      const messageContent = document.createElement('div');
      messageContent.classList.add('message-content');
      messageContent.textContent = content;

      messageElement.appendChild(messageContent);
      chat.appendChild(messageElement);

      chat.scrollTop = chat.scrollHeight;
    }
    // // 화면에 메시지 표시 함수
    // function displayMessage(sender, content, isCurrentUser) {
    //   const chat = document.getElementById('chat');
    //   const messageElement = document.createElement('div');
    //   messageElement.classList.add('message');
    //
    //   if (isCurrentUser) {
    //     messageElement.classList.add('message-right');
    //   } else {
    //     messageElement.classList.add('message-left');
    //   }
    //
    //   messageElement.textContent = `${sender}: ${content}`;
    //   chat.appendChild(messageElement);
    //
    //   // Clearfix 적용
    //   const clearfix = document.createElement('div');
    //   clearfix.classList.add('clearfix');
    //   chat.appendChild(clearfix);
    //
    //   // 채팅 스크롤을 가장 아래로 이동
    //   chat.scrollTop = chat.scrollHeight;
    // }
  </script>
</th:block>
</body>
</html>
