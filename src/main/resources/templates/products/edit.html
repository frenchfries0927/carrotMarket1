<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
  <title>상품 수정</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    .carousel {
      position: relative;
    }

    /* 이미지 미리보기 영역 스타일 */
    .image-preview {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .image-item {
      display: inline-block;
      position: relative;
    }

    .image-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }

    .delete-icon {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .submit-btn {
      background-color: #ff8a3d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    .submit-btn:hover {
      background-color: #e6762d;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="write-container">
    <h1 class="mb-4">상품 수정</h1>
    <form th:action="@{/products/update/{id}(id=${product.id})}"
          method="post" enctype="multipart/form-data">

      <div class="content-wrapper">
        <div class="image-section">
          <!-- 기존 이미지 표시 영역 -->
          <div class="image-preview" id="existingImagePreview" th:if="${!#lists.isEmpty(product.images)}">
            <div th:each="image, iterStat : ${product.images}" class="image-item" th:id="${'image-' + iterStat.index}">
              <img th:src="${image.imageUrl}" style="width: 100px; height: 100px;" />
              <div class="delete-checkbox">
                <button type="button" class="delete-icon"
                        onclick="deleteExistingImage([[${iterStat.index}]])">X</button>
              </div>
            </div>
          </div>

          <!-- 새 이미지 업로드 영역 -->
          <div class="image-upload">
            <p>이미지를 업로드해주세요</p>
            <input type="file" id="imageInput" name="productImages" multiple accept="image/*"/>
          </div>
        </div>

        <div class="form-section">
          <div class="form-group">
            <label class="form-label">카테고리</label>
            <select id="category" name="categoryId" class="form-control" required>
              <option value="" disabled>카테고리를 선택하세요</option>
              <option th:each="category : ${category}"
                      th:value="${category.id}"
                      th:text="${category.name}"
                      th:selected="${product.categoryId == category.id}"></option>
            </select><br>
          </div>

          <div class="form-group">
            <label class="form-label">제목</label>
            <input type="text" class="form-control" name="title" th:field="*{product.title}" th:value="${product.title}" required>
          </div>

          <div class="form-group">
            <label class="form-label">설명</label>
            <textarea class="form-control" name="description" rows="5" th:field="*{product.description}" required th:text="${product.description}"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">가격</label>
            <input type="number" class="form-control" name="price" th:field="*{product.price}" th:value="${product.price}" required>
          </div>

          <button type="submit" class="submit-btn">등록하기</button>
        </div>
      </div>
    </form>
  </div>
</div>

<th:block layout:fragment="pageScript">
  <script>
    // 새 이미지 업로드 시 미리보기 추가
    document.getElementById('imageInput').addEventListener('change', function (e) {
      const existingImagePreview = document.getElementById('existingImagePreview');

      // 새로 업로드된 파일을 기존 이미지 표시 영역에 추가
      for (let file of e.target.files) {
        const reader = new FileReader();

        reader.onload = function (event) {
          const imgWrapper = document.createElement('div');
          imgWrapper.classList.add('image-item');

          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.width = '100px';
          img.style.height = '100px';
          img.style.objectFit = 'cover';

          const deleteButton = document.createElement('button');
          deleteButton.classList.add('delete-icon');
          deleteButton.textContent = 'X';
          deleteButton.onclick = function () {
            imgWrapper.remove();
          };

          imgWrapper.appendChild(img);
          imgWrapper.appendChild(deleteButton);
          existingImagePreview.appendChild(imgWrapper);
        };

        reader.readAsDataURL(file);
      }
    });

    // 기존 이미지 삭제 함수
    function deleteExistingImage(index) {
      const imageElement = document.getElementById('image-' + index);
      if (imageElement) {
        imageElement.remove();
      }
    }
  </script>
</th:block>
</body>
</html>
